@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@model Arihant.Models.Company_Master.CompanyProfileModel
@{
    bool isEdit = Model != null && Model.CompanyID > 0;
    ViewData["Title"] = isEdit ? "Edit Company" : "Add Company";
}
<head>
    <link href="~/css/datatables.css" rel="stylesheet" />
    <link href="~/css/allmin.css" rel="stylesheet" />
    <link href="~/css/toggle.min.css" rel="stylesheet" />

    <link href="~/css/sumoselect.css" rel="stylesheet" />
    <style>
        .floatleft {
            float: left;
        }

        .padding10 {
            padding: 10px;
        }

        .padding20 {
            padding: 20px;
        }

        .marginB20 {
            margin-bottom: 20px;
        }

        .BorderRounded5 {
            border-radius: 5px;
        }

        .BorderRounded10 {
            border-radius: 10px;
        }

        .Shadow {
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }

        .clear {
            clear: both;
        }

        .bg {
            background-color: #f4f7f6;
        }

        .BgColor1 {
            background-color: #ffffff;
        }

        .Border1 {
            border: 1px solid #dee2e6;
        }

        /* --- Responsive Header --- */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        /* --- Buttons --- */
        .btn-action {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        .btn-add {
            background-color: #000080;
            color: white;
        }

        .btn-edit {
            background-color: #ffc107;
            color: black;
            margin-right: 5px;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            width: 200px;
            font-size: 16px;
        }

        .text-right {
            text-align: right;
        }

        .grid-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 15px;
        }

        .custom-grid {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            font-size: 13px;
            border: 1px solid #eee;
        }

            .custom-grid th, .custom-grid td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
                border-bottom: 1px solid #eee;
            }

            .custom-grid th {
                background-color: #f1f3f9;
                font-weight: bold;
            }

        /* --- Modal --- */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
            padding: 20px 10px;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 70%;
            position: relative;
        }

        .TextBox {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        @@media (max-width: 768px) {
            .col-lg-4, .col-lg-6, .col-lg-12 {
                width: 100% !important;
                float: none !important;
                padding: 5px 5px !important;
            }

            .modal-content {
                width: 95% !important;
            }

            .btn-save {
                width: 100% !important;
            }

        }
    </style>
</head>
<body class="bg">
    <div class="wrapper paddingLR10">
        <div class="col-lg-textcenter padding10 Heading FontColor1 AllCaps">
            <strong>@ViewData["Title"]</strong>

            <input type="hidden" id="companyID" value="@(Model?.CompanyID ?? 0)" />
        </div>

        <form id="CompanyForm">
            @Html.Partial("_CompanyDetails")
            @Html.Partial("_ContactCommunication")

            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Address Details</strong></div>
                    <button type="button" id="Add" class="btn-action btn-add" onclick="ShowAdd()">+ Add Address </button>


                </div>
                <hr />
                <div id="MAinAddDive" style="display:none">
                    <div class="col-lg-4 floatleft padding10">
                        <label>Address Type<span style="color:red;margin-left:3px">*</span></label>
                        <select id="ddlAddressType" class="TextBox">
                            <option value="">-- Select Type --</option>
                            @if (ViewBag.Addresslist != null)
                            {
                                foreach (var item in (IEnumerable<Arihant.Models.Company_Master.C_Master>)ViewBag.Addresslist)
                                {
                                    <option value="@item.ID">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="clear"></div>

                    @Html.Partial("_AddressDetails", "MainAddr")
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                        <button type="button" id="AddMainADd" style="display:none" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>
                    </div>

                </div>


                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblAddress">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Address 1</th>
                                <th>Address 2</th>
                                <th>Landmark</th>
                                <th>Pincode</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>GST No.</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Bank Details</strong></div>
                    <button type="button" id="AddBank" class="btn-action btn-add" onclick="DisplayBankDiv()">+ Add Bank </button>

                </div>
                <hr />
                <div id="BankDiv" style="display:none">
                    @Html.Partial("_BankDetails", "MainBank")
                    <div class="clear"></div>

                </div>


                <div class="col-lg-2 floatleft padding10">
                    <button type="button" id="AddBankList" style="display:none" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank Account</button>
                </div>

                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblBank">
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Branch Name</th>
                                <th>Account No</th>
                                <th>IFSC</th>
                                <th>Account Type</th>
                                <th>Holder</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft padding20 text-right">
                <div class="col-lg-12 floatleft padding20 text-right">
                    <button class="btn-action"
                            style="background-color:#000080; color:white; width:100px; font-size:16px;"
                            onclick="location.href='@Url.Action("Vender_Master", "Users_Master")'">
                        Back
                    </button>

                    @if (ViewBag.IsEdit == true)
                    {
                        <button type="submit" class="btn-action" style="background-color:#ffc107; color:black; width:200px; font-size:16px;">Update Company Master</button>
                    }
                    else
                    {
                        <button type="button"onclick="SaveCompany()" class="btn-action btn-save">
                            Save
                        </button>
                    }
                </div>
            </div>
        </form>
    </div>
</body>
<div id="editModal" class="custom-modal">
    <div class="modal-content Shadow">
        <div class="section-header">
            <div class="NormalTextBig FontColor1"><strong id="modalHeading">Edit Details</strong></div>
            <button type="button" onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <hr />
        <div id="modalInputs" class="clear"></div>
        <div class="clear"></div>
        <hr />
        <div class="text-right">
            <button type="button" class="btn-action" style="background:#6c757d; color:white;" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn-action btn-add" id="btnSaveUpdate">Update Details</button>
        </div>
    </div>
</div>
<script>

    window.AppConfig = {
        UserMasterBaseUrl: '@Url.Content(Configuration["ApiSettings:UserMasterBaseUrl"])'
    };
    console.log("AppConfig Initialized:", window.AppConfig);
</script>
<script src="~/js/jquery-3.7.1.js"></script>
<script src="~/js/sweetalert2.js"></script>
<script src="~/js/masters/address.js"></script>
<script src="~/js/masters/contactdetails.js"></script>
<script src="~/js/masters/bankdetails.js"></script>


<script>

          var companyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
          var countryList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.countrylist));

        async function FillFormData(data) {


            console.log(JSON.stringify(data));
                
            bindIdentityDetails(data);
                     bindContactDetails(
                data.Email,                   
                data.AlternetEmail,           
                data.ContactPersonName,       
                data.OfficeMobileNO,          
                data.WhatsAppNO,              
                data.Website,
               data.Tel1,
                    data.MobileNumber             
            );
           PopulateGridsForEdit();

          }

          function bindIdentityDetails(data) {
    $("#companyID").val(data.CompanyID || 0);
     $("input[name='CompanyName']").val(data.CompanyName);
    // $("input[name='CEegistration']").val(data.Central_Excise_Registration);
    // $("input[name='CERange']").val(data.Central_Excise_Range);
    $("input[name='TINNO']").val(data.TIN_NO);
    // $("input[name='VATNO']").val(data.VAT_NO);
    // $("input[name='CSTNO']").val(data.CSTNO);
    // $("input[name='STNO']").val(data.STNO);
    $("input[name='ECCNO']").val(data.ECCNO);
    $("input[name='GSTNo']").val(data.GSTNo);
    $("input[name='CompanyemailID']").val(data.CompanyemailID);

}

    function PopulateGridsForEdit() {

      $('#tblBank')
        .show();
      $('#tblAddress')
        .show();
      var fullModel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
      console.log("Binding Full Vendor Model Data...", fullModel);

      if (!fullModel) return;

      bindContactDetails(
        fullModel.Email
        , fullModel.AlternetEmail
        , fullModel.ContactPersonName
        , fullModel.OfficeMobileNO
        , fullModel.WhatsAppNO
        , fullModel.Website
                , fullModel.Tel1
        , fullModel.MobileNumber
      );

      if (fullModel.AddressDetails) {

        var bindAddressTableArray = typeof fullModel.AddressDetails === 'string' ?
          JSON.parse(fullModel.AddressDetails) :
          fullModel.AddressDetails;
                
        bindAddressTable(bindAddressTableArray);
      }


      if (fullModel.BankList) {

        var bankDataArray = typeof fullModel.BankList === 'string' ?
          JSON.parse(fullModel.BankList) :
          fullModel.BankList;

        bindBankTable(bankDataArray);
      }
      console.log("Binding Complete!");
    }

        function DisplayBankDiv() {
          $("#modalHeading")
            .text("Add Bank Details");
          var bankContent = $('#BankDiv')
            .html();
          $("#modalInputs")
            .html(bankContent);
          $("#editModal")
            .show();
          $("#btnSaveUpdate")
            .hide();
          $("#btnModalAddBank")
            .remove();
          var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
            '<button type="button" id="btnModalAddBank" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank to List</button>' +
            '</div>';
          $("#modalInputs")
            .append(addBtn);
        }

        function ShowAdd() {
          $("#modalHeading")
            .text("Add Address Details");
          var addressContent = $('#MAinAddDive')
            .html();
          $("#modalInputs")
            .html(addressContent);
          $("#editModal")
            .show();
          $("#btnSaveUpdate")
            .hide();
          $("#btnModalAddAddr")
            .remove();

          var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
            '<button type="button" id="btnModalAddAddr" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>' +
            '</div>';
          $("#modalInputs")
            .append(addBtn);
          $('#MAinAddDive')
            .hide();
        }


          $(document).ready(function () {
              InitializeStates();

              console.log(JSON.stringify(companyData));
            
              if (companyData && companyData.CompanyID > 0) {
                  FillFormData(companyData);
              }
          });


        function InitializeStates() {
            bindDropdownList(["MainAddr_Country", "BankAddr_Country"], countryList);
        }

        function closeModal() { $("#editModal").hide(); currentRow = null; }


   

            function SaveCompany() {


      const identity = getIdentityDetails();
      const model = {
        CompanyID: identity.CompanyID
        , CompanyName: identity.CompanyName
        // , CEegistration: identity.CEegistration
        // , CERange: identity.CERange
        , TINNO: identity.TINNO
        // , VATNO: identity.VATNO
        // , CSTNO: identity.CSTNO
        // , STNO: identity.STNO
        , ECCNO: identity.ECCNO
        , GSTNo: identity.GSTNo
        , CompanyemailID: identity.CompanyemailID
        , ...getContactDetails()
        , AddressList: getAddressTableData()
        , BankList: getBankTableData()

      };


         if (!model.CompanyName || model.CompanyName.trim() === "") {
            Swal.fire({ icon: 'warning', title: 'Required', text: 'Company Name is required.', timer: 4000, timerProgressBar: true });
            return;
        }
          if (!model.GSTNo || model.GSTNo.trim() === "") {
            Swal.fire({
                icon: 'warning',
                title: 'Required',
                text: 'GST No. is required.',
                timer: 4000,
                timerProgressBar: true
            });
            return;
        } else {
      
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;

            if (!gstRegex.test(model.GSTNo.trim().toUpperCase())) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Format',
                    text: 'Please enter a valid GST Number (e.g., 22AAAAA0000A1Z5).',
                    timer: 4000,
                    timerProgressBar: true
                });
                return;
            }
        }

        if (!model.CompanyemailID || model.CompanyemailID.trim() === "") {
            Swal.fire({ icon: 'warning', title: 'Required', text: 'Company Email ID is required.', timer: 4000, timerProgressBar: true });
            return;
        }


        if (!model.MobileNo || model.MobileNo.trim() === "") {
            Swal.fire({ icon: 'warning', title: 'Required', text: 'Mobile Number is required.', timer: 4000, timerProgressBar: true });
            return;
        } else if (model.MobileNo.length !== 10) {
            Swal.fire({ icon: 'warning', title: 'Invalid Length', text: 'Mobile Number must be exactly 10 digits.', timer: 4000, timerProgressBar: true });
            return;
        }


        if (model.OffMobileNO && model.OffMobileNO.trim() !== "" && model.OffMobileNO.replace(/\D/g, '').length !== 10) {
            Swal.fire({ icon: 'warning', title: 'Invalid Length', text: 'Office Mobile No must be 10 digits.', timer: 4000, timerProgressBar: true });
            return;
        }
        if (model.WhatsappNo && model.WhatsappNo.trim() !== "" && model.WhatsappNo.replace(/\D/g, '').length !== 10) {
            Swal.fire({ icon: 'warning', title: 'Invalid Length', text: 'Whatsapp No must be 10 digits.', timer: 4000, timerProgressBar: true });
            return;
        }
        if (model.Tel1 && model.Tel1.trim() !== "" && model.Tel1.replace(/\D/g, '').length !== 10) {
            Swal.fire({ icon: 'warning', title: 'Invalid Length', text: 'Telephone (Tel1) must be 10 digits.', timer: 4000, timerProgressBar: true });
            return;
        }

            if (!model.AddressList || model.AddressList.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Required',
                text: 'Please add at least one address.',
                timer: 4000,
                timerProgressBar: true
            });
            return;
        }


        if (!model.BankList || model.BankList.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Required',
                text: 'Please add at least one bank account detail.',
                timer: 4000,
                timerProgressBar: true
            });
            return;
        }

               
      const id = parseInt(identity.CompanyID) || 0;
      const actionUrl = id > 0 ?
        '@Url.Action("UpdateCompanyProfile", "Users_Master")' :
        '@Url.Action("SaveCompanyProfile", "Users_Master")';

            Swal.showLoading();

      $.ajax({
        url: actionUrl
        , type: 'POST'
        , data: {
          data: JSON.stringify(model)
        }
        , success: function(response) {
          if (response.success) {
            Swal.fire({
                icon: 'success'
                , title: 'Success!'
                , text: response.message
                , confirmButtonColor: '#000080'
              })
              .then(() => {
                window.location.href = '@Url.Action("GetCompanyList", "Users_Master")';
              });
          } else {
            Swal.fire("Error", response.message, "error");
          }
        }
        , error: function(xhr) {
          console.error(xhr.responseText);
          Swal.fire("Error", "A server-side error occurred.", "error");
        }
      });
    }

        
        function getIdentityDetails() {
        return {
            CompanyID: $("#companyID").val(),
            CompanyName: $("input[name='CompanyName']").val().trim(),
           
            TINNO: $("input[name='TINNO']").val().trim(),

            // VATNO: $("input[name='VATNO']").val().trim(),
            // CSTNO: $("input[name='CSTNO']").val().trim(),
            // STNO: $("input[name='STNO']").val().trim(),
            ECCNO: $("input[name='ECCNO']").val().trim(),
            GSTNo: $("input[name='GSTNo']").val().trim(),
            CompanyemailID: $("input[name='CompanyemailID']").val().trim()

        };
    }
</script>