@using Arihant.Models.Company_Master

@{
    ViewData["Title"] = "Customer List";
}


<head>
    <link href="~/css/datatables.css" rel="stylesheet" />
    <link href="~/css/allmin.css" rel="stylesheet" />
    <link href="~/css/toggle.min.css" rel="stylesheet" />

    <link href="~/css/sumoselect.css" rel="stylesheet" />
    <style>

        /* --- General Layout --- */
        .floatleft {
            float: left;
        }

        .padding10 {
            padding: 10px;
        }

        .padding20 {
            padding: 20px;
        }

        .marginB20 {
            margin-bottom: 20px;
        }

        .BorderRounded5 {
            border-radius: 5px;
        }

        .BorderRounded10 {
            border-radius: 10px;
        }

        .Shadow {
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }

        .clear {
            clear: both;
        }

        .bg {
            background-color: #f4f7f6;
        }

        .BgColor1 {
            background-color: #ffffff;
        }

        .Border1 {
            border: 1px solid #dee2e6;
        }

        /* --- Responsive Header --- */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        /* --- Buttons --- */
        .btn-action {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        .btn-add {
            background-color: #000080;
            color: white;
        }

        .btn-edit {
            background-color: #ffc107;
            color: black;
            margin-right: 5px;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            width: 200px;
            font-size: 16px;
        }

        .text-right {
            text-align: right;
        }

        .grid-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 15px;
        }

        .custom-grid {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            font-size: 13px;
            border: 1px solid #eee;
        }

            .custom-grid th, .custom-grid td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
                border-bottom: 1px solid #eee;
            }

            .custom-grid th {
                background-color: #f1f3f9;
                font-weight: bold;
            }

        /* --- Modal --- */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
            padding: 20px 10px;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 70%;
            position: relative;
        }

        .TextBox {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        @@media (max-width: 768px) {
            .col-lg-4, .col-lg-6, .col-lg-12 {
                width: 100% !important;
                float: none !important;
                padding: 5px 5px !important;
            }

            .modal-content {
                width: 95% !important;
            }

            .btn-save {
                width: 100% !important;
            }
        }
    </style>
</head>
<body class="bg">
    <div class="wrapper paddingLR10">
        <div class="col-lg-textcenter padding10 Heading FontColor1 AllCaps">
            <strong>Company Master</strong>
        </div>

        <form id="CompanyForm">
            @Html.Partial("_CompanyDetails")


            @Html.Partial("_ContactCommunication")

            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Address Details</strong></div>
                    <button type="button" id="Add" class="btn-action btn-add" onclick="ShowAdd()">+ Add Address </button>


                </div>
                <hr />
                <div id="MAinAddDive" style="display:none">
                    <div class="col-lg-4 floatleft padding10">
                        <label>Address Type<span style="color:red;margin-left:3px">*</span></label>
                        <select id="ddlAddressType" class="TextBox">
                            <option value="">-- Select Type --</option>
                            @if (ViewBag.Addresslist != null)
                            {
                                foreach (var item in (IEnumerable<Arihant.Models.Company_Master.C_Master>)ViewBag.Addresslist)
                                {
                                    <option value="@item.ID">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="clear"></div>

                    @Html.Partial("_AddressDetails", "MainAddr")
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                        <button type="button" id="AddMainADd" style="display:none" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>
                    </div>

                </div>


                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblAddress">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Address 1</th>
                                <th>Address 2</th>
                                <th>Landmark</th>
                                <th>Pincode</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>GST No.</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Bank Details</strong></div>
                    <button type="button" id="AddBank" class="btn-action btn-add" onclick="DisplayBankDiv()">+ Add Bank </button>

                </div>
                <hr />
                <div id="BankDiv" style="display:none">
                    @Html.Partial("_BankDetails", "MainBank")
                    <div class="clear"></div>

                </div>


                <div class="col-lg-2 floatleft padding10">
                    <button type="button" id="AddBankList" style="display:none" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank Account</button>
                </div>

                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblBank">
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Account No</th>
                                <th>IFSC</th>
                                <th>Type</th>
                                <th>Holder</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft padding20 text-right">
                <div class="col-lg-12 floatleft padding20 text-right">
                    <button class="btn-action"
                            style="background-color:blue; color:black; width:100px; font-size:16px;"
                            onclick="location.href='@Url.Action("Vender_Master", "Users_Master")'">
                        Back
                    </button>

                    @if (ViewBag.IsEdit == true)
                    {
                        <button type="submit" class="btn-action" style="background-color:#ffc107; color:black; width:200px; font-size:16px;">Update Vendor Master</button>
                    }
                    else
                    {
                        <button type="submit" class="btn-action btn-save">Save Vendor Master</button>
                    }
                </div>
            </div>
        </form>
    </div>

    <div id="editModal" class="custom-modal">
        <div class="modal-content Shadow">
            <div class="section-header">
                <div class="NormalTextBig FontColor1"><strong id="modalHeading">Edit Details</strong></div>
                <button type="button" onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <hr />
            <div id="modalInputs" class="clear"></div>
            <div class="clear"></div>
            <hr />
            <div class="text-right">
                <button type="button" class="btn-action" style="background:#6c757d; color:white;" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-action btn-add" id="btnSaveUpdate">Update Details</button>
            </div>
        </div>
    </div>

</body>

<script src="~/js/jquery-3.7.1.js"></script>
<script src="~/js/sweetalert2.js"></script>

<script>
        function showError(msg) {
        Swal.fire("Validation Error", msg, "error");
        return false;
    }
       function DisplayBankDiv()
        {
                  $("#modalHeading").text("Add Bank Details");


        var bankContent = $('#BankDiv').html();
        $("#modalInputs").html(bankContent);

        $("#editModal").show();
        $("#btnSaveUpdate").hide();
        $("#btnModalAddBank").remove();
        var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
                     '<button type="button" id="btnModalAddBank" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank to List</button>' +
                     '</div>';
        $("#modalInputs").append(addBtn);
        }
        function ShowAdd()
        {
                $("#modalHeading").text("Add Address Details");


        var addressContent = $('#MAinAddDive').html();
        $("#modalInputs").html(addressContent);
        $("#editModal").show();
        $("#btnSaveUpdate").hide();
        $("#btnModalAddAddr").remove();

        var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
                     '<button type="button" id="btnModalAddAddr" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>' +
                     '</div>';
        $("#modalInputs").append(addBtn);

        $('#MAinAddDive').hide();
        }

         function InitializeStates() {
            const dropdowns = ["MainAddr_Country", "BankAddr_Country"];
            dropdowns.forEach(id => {
                let dropdown = document.getElementById(id);
                if(dropdown) {
                    countryList.forEach(c => {
                        dropdown.add(new Option(c.Name, c.ID));
                    });
                }
            });
        }

        $(document).ready(function() {
            InitializeStates();

              var isEdit = '@ViewBag.IsEdit'.toLowerCase() === 'true';
                if (isEdit) {
                    PopulateGridsForEdit();
                }


            $("#VendorForm").on("submit", function(e) {
                e.preventDefault();
                SaveAllData();
            });
        });



        function OnCountryChange(countryid, prefix) {
                                    var modal = $("#modalInputs");
                                    var stateDropdown = modal.find("#" + prefix + "_State");
                                    var cityDropdown = modal.find("#" + prefix + "_City");
                                    stateDropdown.html('<option value="">-- Select State --</option>');
                                    cityDropdown.html('<option value="">-- Select City --</option>');

                                    if (!countryid) return;

                                    $.get('@Url.Action("GetState", "Users_Master")', { countryid: countryid }, function (data) {
                                        if (data && data.length > 0) {
                                            var options = '';
                                            data.forEach(function (s) {
                                                options += '<option value="' + s.id + '">' + s.name + '</option>';
                                            });
                                            stateDropdown.append(options);

                                            console.log("States appended to #" + prefix + "_State");
                                        }
                                    }).fail(function() {
                                        Swal.fire('Error', 'Could not load states', 'error');
                                    });
                        }

               function OnStateChange(stateId, prefix) {
            var modal = $("#modalInputs");
            var cityDropdown = modal.find("#" + prefix + "_City");
            cityDropdown.html('<option value="">-- Select City --</option>');

            if (!stateId) return;

            $.get('@Url.Action("GetCitiesByState", "Users_Master")', { stateId: stateId }, function (data) {
                console.log("City Data Received:", JSON.stringify(data));

                if (data && data.length > 0) {
                    var options = '';
                    data.forEach(function (c) {
                        options += '<option value="' + c.id + '">' + c.name + '</option>';
                    });
                    cityDropdown.append(options);
                }
            }).fail(function() {
                console.error("Error fetching cities for stateId: " + stateId);
            });
        }

              function AddAddressToGrid() {
            let p = "MainAddr";
            let modal = $("#modalInputs");

            let typeID = modal.find("#ddlAddressType").val();
            let typeName = modal.find("#ddlAddressType option:selected").text();
            let a1 = modal.find(`#${p}_AddressLine1`).val();
            let a2 = modal.find(`#${p}_AddressLine2`).val();
            let pin = modal.find(`#${p}_Pincode`).val();
            let lnd = modal.find(`#${p}_Landmark`).val();
            let cID = modal.find(`#${p}_Country`).val();
            let cText = modal.find(`#${p}_Country option:selected`).text();
            let sID = modal.find(`#${p}_State`).val();
            let sText = modal.find(`#${p}_State option:selected`).text();
            let ctID = modal.find(`#${p}_City`).val();
            let ctText = modal.find(`#${p}_City option:selected`).text();
            let gstNo = modal.find(`#${p}_GSTNo`).val().trim();

              const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
                          if (!gstRegex.test(gstNo)) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Invalid Main GST format. Expected: 22AAAAA0000A1Z5',
                target: document.getElementById('editModal')
            });
            return;
        }


                    if (!typeID || !a1 || !pin || !cID || !sID || !ctID) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please fill all mandatory address fields',
                target: document.getElementById('editModal')
            });
            return;
        }





                 let isDuplicate = false;

                  $("#tblAddress tbody tr").each(function() {
                     let existingAccNo = $(this).find("td:eq(8)").text().trim();
                      if (existingAccNo === gstNo) {
                         isDuplicate = true;
                         return false; // Break the .each() loop
                     }
                 });

                 if (isDuplicate) {
                     Swal.fire({
                         icon: 'warning',
                         title: 'Duplicate Entry',
                         text: 'This GST Number is already added to the list.',
                         target: document.getElementById('editModal')
                     });
                     return;
                 }

            let row = `<tr>
                <td>${typeName}</td>
                <td>${a1}</td>
                <td>${a2}</td>
                <td>${lnd}</td>
                <td>${pin}</td>
                <td>${ctText}</td>
                <td>${sText}</td>
                <td>${cText}</td>
                <td>${gstNo}</td>
                <td>
                    <button type="button" class="btn-action btn-edit" onclick="OpenEditModal(this, 'ADDR')">Edit</button>
                    <button type="button" class="btn-action btn-remove" onclick="$(this).closest('tr').remove()">Remove</button>
                </td>
                <td style="display:none;">${typeID}</td>
                <td style="display:none;">${cID}</td>
                <td style="display:none;">${sID}</td>
                <td style="display:none;">${ctID}</td>
            </tr>`;


            $("#tblAddress tbody").append(row);
            $('#tblAddress').show();


            closeModal();


            $(`#${p}_AddressLine1, #${p}_AddressLine2, #${p}_Pincode, #${p}_Landmark`).val('');
            $(`#${p}_Country, #${p}_State, #${p}_City, #ddlAddressType`).val('').trigger('change');
        }



                       function AddBankToGrid() {
            let modal = $("#modalInputs");

            let bName = modal.find("input[name='BankName']").val().trim();
            let holder = modal.find("input[name='AccountHolderName']").val().trim();
            let accType = modal.find("select[name='AccountType']").val();
            let accNo = modal.find("input[name='AccountNo']").val().trim();
            let ifsc = modal.find("input[name='IFSCCode']").val().trim().toUpperCase();

              if (!bName || !holder || !accType) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'All bank fields are mandatory',
                target: document.getElementById('editModal') // Add this
            });
            return;
        }



            if (!accNo || isNaN(accNo) || parseInt(accNo) < 0 || !Number.isInteger(Number(accNo))) {

                 Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Account Number must be a valid positive integer',
                target: document.getElementById('editModal') // Add this
            });
                return;
            }


            let ifscRegex = /^[A-Z]{4}0[A-Z0-9]{6}$/;
            if (!ifsc) {

                  Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'IFSC Code is mandatory',
                target: document.getElementById('editModal') // Add this
            });

                return;
            } else if (!ifscRegex.test(ifsc)) {

                   Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Invalid IFSC format. Example: SBIN0001234',
                target: document.getElementById('editModal') // Add this
            });


                return;
            }



                let isDuplicate = false;

                $("#tblBank tbody tr").each(function() {
                    let existingAccNo = $(this).find("td:eq(1)").text().trim();
                    if (existingAccNo === accNo) {
                        isDuplicate = true;
                        return false; // Break the .each() loop
                    }
                });

                if (isDuplicate) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Duplicate Entry',
                        text: 'This Account Number is already added to the list.',
                        target: document.getElementById('editModal')
                    });
                    return;
                }


            $('#AddBankList').hide();
            $('#BankDiv').hide();
            $('#AddBank').show();
            $('#tblBank').show();


            let row = `<tr>
                <td>${bName}</td>
                <td>${accNo}</td>
                <td>${ifsc}</td>
                <td>${accType}</td>
                <td>${holder}</td>
                <td>
                    <button type="button" class="btn-action btn-edit" onclick="OpenEditModal(this, 'BANK')">Edit</button>
                    <button type="button" class="btn-action btn-remove" onclick="$(this).closest('tr').remove()">Remove</button>
                </td>
            </tr>`;


            $("#tblBank tbody").append(row);


            closeModal();
            $("input[name='BankName'], input[name='AccountNo'], input[name='IFSCCode'], input[name='AccountHolderName']").val('');
            $("select[name='AccountType']").val('');
        }


                      function OpenEditModal(btn, type) {
            currentRow = $(btn).closest('tr');
            editType = type;
            let cells = currentRow.find('td');


            $("#btnSaveUpdate").show().text("Update Details");

                $("#btnModalAddBank").remove();
        $("#btnModalAddAddr").remove();

            if (type === 'ADDR') {
                      $("#modalHeading").text("Edit Address");

                $("#modalInputs").html($('#MAinAddDive').html());
                let modal = $("#modalInputs");


                modal.find("#ddlAddressType").val(cells.eq(9).text());
                modal.find("#MainAddr_AddressLine1").val(cells.eq(1).text());
                modal.find("#MainAddr_AddressLine2").val(cells.eq(2).text());
                modal.find("#MainAddr_Landmark").val(cells.eq(3).text());
                modal.find("#MainAddr_Pincode").val(cells.eq(4).text());


                modal.find("#MainAddr_GSTNo").val(cells.eq(8).text());

                populateModalDropdowns(
                    cells.eq(10).text(),
                    cells.eq(11).text(),
                    cells.eq(12).text(),
                    cells.eq(13).text()
                );
            } else {
                $("#modalHeading").text("Edit Bank & Branch");


                $("#modalInputs").html($('#BankDiv').html());


                let modal = $("#modalInputs");
                modal.find("input[name='BankName']").val(cells.eq(0).text());
                modal.find("input[name='AccountNo']").val(cells.eq(1).text());
                modal.find("input[name='IFSCCode']").val(cells.eq(2).text());
                modal.find("select[name='AccountType']").val(cells.eq(3).text());
                modal.find("input[name='AccountHolderName']").val(cells.eq(4).text());
            }

            $("#editModal").show();
        }

        function generateAddressHTML(typeOpts, a1, a2, lnd, pin, countryOpts, isBank = false) {
            let typeField = isBank ? "" : `<div class="col-lg-4 floatleft padding10"><label>Address Type<span style="color:red;margin-left:3px">*</span></label><select id="m_type" class="TextBox">${typeOpts}</select></div><div class="clear"></div>`;
            return `${typeField}
                <div class="col-lg-6 floatleft padding10"><label>Address Line 1<span style="color:red;margin-left:3px">*</span></label><input type="text" id="m_a1" class="TextBox" value="${a1}"></div>
                <div class="col-lg-6 floatleft padding10"><label>Address Line 2</label><input type="text" id="m_a2" class="TextBox" value="${a2}"></div>
                <div class="col-lg-4 floatleft padding10"><label>Landmark</label><input type="text" id="m_lnd" class="TextBox" value="${lnd}"></div>
                <div class="col-lg-4 floatleft padding10"><label>Pincode<span style="color:red;margin-left:3px">*</span></label><input type="number" id="m_pin" class="TextBox" value="${pin}"></div>
                <div class="col-lg-4 floatleft padding10"><label>Country<span style="color:red;margin-left:3px">*</span></label><select id="m_country" class="TextBox" onchange="OnCountryChange(this.value, 'm')">${countryOpts}</select></div>
                <div class="col-lg-4 floatleft padding10"><label>State<span style="color:red;margin-left:3px">*</span></label><select id="m_State" class="TextBox" onchange="OnStateChange(this.value, 'm')"><option value="">--Select--</option></select></div>
                <div class="col-lg-4 floatleft padding10"><label>City<span style="color:red;margin-left:3px">*</span></label><select id="m_City" class="TextBox"><option value="">--Select--</option></select></div>`;
        }

         function populateModalDropdowns(typeID, countryID, stateID, cityID) {

             let modal = $("#modalInputs");
            if (typeID) {
             modal.find("#ddlAddressType").val(typeID);
            }


            if (countryID) {
                 modal.find("#MainAddr_Country").val(countryID);

                $.ajax({
                    url: '@Url.Action("GetState", "Users_Master")',
                    type: "GET",
                    data: { countryid: countryID },
                    async: false,
                    success: function (list) {
                        let stateDD = modal.find("#MainAddr_State").empty().append('<option value="">--Select State--</option>');
                        if (list && list.length > 0) {
                            list.forEach(i => {
                                stateDD.append(new Option(i.name, i.id));
                            });
                        }
                        modal.find("#MainAddr_State").val(stateID);
                    }
                });
            }


            if (stateID) {
                $.ajax({
                    url: '@Url.Action("GetCitiesByState", "Users_Master")',
                    type: "GET",
                    data: { stateId: stateID },
                    async: false,
                    success: function (list) {
                        let cityDD = modal.find("#MainAddr_City").empty().append('<option value="">--Select City--</option>');
                        if (list && list.length > 0) {
                            list.forEach(i => {
                                cityDD.append(new Option(i.name, i.id));
                            });
                        }
                        modal.find("#MainAddr_City").val(cityID);
                    }
                });
            }
        }

                              $("#btnSaveUpdate").click(function () {
            if (!currentRow) return;
               let cells = currentRow.find('td');
        let modal = $("#modalInputs");

        let p = "MainAddr";

            const showModalError = (msg) => {
                Swal.fire({
                    icon: 'error',
                    title: 'Missing Information',
                    text: msg,
                    target: document.getElementById('editModal'),
                    confirmButtonColor: '#000080'
                });
            };


            let pinRegex = /^[1-9][0-9]{5}$/;

            if (editType === 'ADDR') {
               let typeID = modal.find("#ddlAddressType").val();
        let typeName = modal.find("#ddlAddressType option:selected").text();
        let a1 = modal.find(`#${p}_AddressLine1`).val().trim();
        let a2 = modal.find(`#${p}_AddressLine2`).val().trim();
        let pin = modal.find(`#${p}_Pincode`).val().trim();
        let lnd = modal.find(`#${p}_Landmark`).val().trim();
        let cID = modal.find(`#${p}_Country`).val();
        let cText = modal.find(`#${p}_Country option:selected`).text();
        let sID = modal.find(`#${p}_State`).val();
        let sText = modal.find(`#${p}_State option:selected`).text();
        let ctID = modal.find(`#${p}_City`).val();
        let ctText = modal.find(`#${p}_City option:selected`).text();
        let gstNo = modal.find(`#${p}_GSTNo`).val().trim();



        if (!typeID) { showModalError('Address Type is mandatory'); return; }
        if (!a1) { showModalError('Address Line 1 is mandatory'); return; }
        if (!pin || !pinRegex.test(pin)) { showModalError('Please enter a valid 6-digit Pincode'); return; }
        if (!cID || !sID || !ctID) { showModalError('Country, State, and City are mandatory'); return; }


        cells.eq(0).text(typeName);
        cells.eq(1).text(a1);
        cells.eq(2).text(a2);
        cells.eq(3).text(lnd);
        cells.eq(4).text(pin);
        cells.eq(5).text(ctText);
        cells.eq(6).text(sText);
        cells.eq(7).text(cText);
        cells.eq(8).text(gstNo);


        let actionHtml = `
            <button type="button" class="btn-action btn-edit" onclick="OpenEditModal(this, 'ADDR')">Edit</button>
            <button type="button" class="btn-action btn-remove" onclick="$(this).closest('tr').remove()">Remove</button>
        `;
        cells.eq(9).html(actionHtml);


        cells.eq(10).text(typeID);
        cells.eq(11).text(cID);
        cells.eq(12).text(sID);
        cells.eq(13).text(ctID);

            } else {

               let bName = modal.find("input[name='BankName']").val().trim();
                let accNo = modal.find("input[name='AccountNo']").val().trim();
                let ifsc = modal.find("input[name='IFSCCode']").val().trim().toUpperCase();
                let accType = modal.find("select[name='AccountType']").val();
                let holder = modal.find("input[name='AccountHolderName']").val().trim();


                if (!bName || !accNo || !ifsc || !holder) {
                    Swal.fire('Error', 'All bank fields are mandatory', 'error');
                    return;
                }

                cells.eq(0).text(bName);
                cells.eq(1).text(accNo);
                cells.eq(2).text(ifsc);
                cells.eq(3).text(accType);
                cells.eq(4).text(holder);



            }

            closeModal();

        });

        function closeModal() { $("#editModal").hide(); currentRow = null; }



        function SaveCompany()
        {

                            var companyName = $("input[name='CompanyName']").val().trim();
                            if (companyName === "") {
                                Swal.fire("Required", "Please enter the Company Name.", "warning");
                                return;
                            }


                        const patterns = {

                            gst: /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/,
                            pan: /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/,
                            ifsc: /^[A-Z]{4}0[A-Z0-9]{6}$/,
                            pincode: /^[1-9][0-9]{5}$/,
                            mobile: /^[6-9]\d{9}$/,
                            website: /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/
                        };


                        var companyName = $("input[name='CompanyName']").val().trim();
                        var regNo = $("input[name='RegNo']").val().trim();
                        var gstNo = $("input[name='GSTNo']").val().trim();
                        var panNo = $("input[name='PANNo']").val().trim();

                        if (companyName === "" || regNo === "" || gstNo === "" || panNo === "") {
                            Swal.fire("Required", "Please fill all Company Identity fields marked with *", "warning");
                            return;
                        }


                        var email = $("input[name='Email']").val().trim();
                        var website = $("input[name='Website']").val().trim();
                        var bankName = $("input[name='BankName']").val().trim();
                        var accNo = $("input[name='AccountNo']").val().trim();
                        var ifsc = $("input[name='IFSCCode']").val().trim();

                        if (email === "" || website === "" || bankName === "" || accNo === "" || ifsc === "") {
                            Swal.fire("Required", "Please fill Email, Website, and Bank details marked with *", "warning");
                            return;
                        }


                        if (!patterns.gst.test(gstNo)) { return showError("Invalid GST No. format (e.g. 22AAAAA0000A1Z5)."); }
                        if (!patterns.pan.test(panNo)) { return showError("Invalid PAN No. format (e.g. ABCDE1234F)."); }
                        if (!patterns.ifsc.test(ifsc)) { return showError("Invalid IFSC Code format (e.g. SBIN0123456)."); }
                        if (!patterns.website.test(website)) { return showError("Invalid Website URL."); }


                        if (!patterns.pincode.test($("#S_Pincode").val())) { return showError("Invalid Sales Pincode (6 digits)."); }
                        if (!patterns.pincode.test($("#B_Pincode").val())) { return showError("Invalid Bank Pincode (6 digits)."); }


                        var primaryMobile = $("input[name='MobileNo']").first().val();
                        if (!patterns.mobile.test(primaryMobile)) { return showError("Invalid Primary Mobile Number (10 digits)."); }


                       var email = $("input[name='Email']").val().trim();
                           if (!validateEmailField("input[name='Email']")) {
                              showError("Please enter a valid email address (e.g., example@gmail.com).");
                                 $("input[name='Email']").focus();
                                   return;
                            }



                              let requiredFields = [
                            { val: $("#S_State").val(), name: "Sales State" },
                            { val: $("#S_City").val(), name: "Sales City" },
                            { val: $("#P_State").val(), name: "Purchase State" },
                            { val: $("#P_City").val(), name: "Purchase City" },
                            { val: $("#B_State").val(), name: "Bank State" },
                            { val: $("#B_City").val(), name: "Bank City" }
                        ];


                        for (let field of requiredFields) {
                            if (field.val === null || field.val.trim() === "") {
                                showError(`Please select ${field.name}`);
                                return false;
                            }
                        }


                        var model = {
                            CompanyName: companyName,
                            RegNo: $("input[name='RegNo']").val(),
                            GSTNo: $("input[name='GSTNo']").val(),
                            PANNo: $("input[name='PANNo']").val(),
                            Email: email,
                            Website: $("input[name='Website']").val(),
                            Telephone: $("input[name='Tel1']").val(),


                            MobileNumbers: $("input[name='MobileNo']").map(function() {
                                return $(this).val();
                            }).get().filter(v => v !== ""),


                            SalesAddress: {
                                Address: $("#S_Address").val(),
                                Landmark: $("#S_Landmark").val(),
                                Pincode: $("#S_Pincode").val(),
                                City: $("#S_City").val(),
                                State: $("#S_State").val()
                            },

                            PurchaseAddress: {
                                Address: $("#P_Address").val(),
                                Landmark: $("#P_Landmark").val(),
                                Pincode: $("#P_Pincode").val(),
                                City: $("#P_City").val(),
                                State: $("#P_State").val()
                            },


                            BankName: $("input[name='BankName']").val(),
                            AccountNo: $("input[name='AccountNo']").val(),
                            IFSCCode: $("input[name='IFSCCode']").val(),
                            BankAddress: $("input[name='BankAddress']").val(),
                            BankLandmark: $("#B_Landmark").val(),
                            BankPincode: $("#B_Pincode").val(),
                            BankCity: $("#B_City").val(),
                            BankState: $("#B_State").val()
                        };


                $.ajax({
                        url: '@Url.Action("SaveCompanyProfile", "Users_Master")',
                        type: 'POST',
                        data: { data: JSON.stringify(model) },
                        success: function (response) {
                            if (response.success) {

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    confirmButtonColor: '#3085d6'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                       window.location.href = '@Url.Action("GetCompanyList", "Users_Master")';
                                    }
                                });
                            } else {

                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: response.message,
                                    confirmButtonColor: '#d33'
                                });
                            }
                        },
                        error: function () {

                            Swal.fire({
                                icon: 'error',
                                title: 'System Error',
                                text: 'Communication failure with the server. Please check your connection.',
                                confirmButtonColor: '#d33'
                            });
                        }
                    });
        }
             function AddMobileRow() {

            var rowCount = $('.mobile-row').length;

            if (rowCount >= 5) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Limit Reached',
                    text: 'You can only add a maximum of 4 mobile numbers.',
                    confirmButtonColor: '#000080'
                });
                return;
            }

            var html = `
            <div class="col-lg-4 floatleft padding10 mobile-row">
                <label>Mobile Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" name="MobileNo" class="TextBox col-lg-10 BorderRounded5" placeholder="Additional No.">
                    <button type="button" class="Button ButtonColor3" onclick="$(this).closest('.mobile-row').remove()"
                            style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; padding: 0; border: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="white" viewBox="0 0 16 16">
                            <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z" stroke="white" stroke-width="1"/>
                        </svg>
                    </button>
                </div>
            </div>`;

            $('#MobileContainer').append(html);
        }



              var StateList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.statelist));
         window.onload = function() {
                    console.log(JSON.stringify(StateList));
                   var S_State = document.getElementById("S_State");

                    StateList.forEach(function(city) {
                        var option = document.createElement("option");
                        option.value = city.ID;
                        option.text = city.Name;
                        S_State.appendChild(option);
                    });

                      var P_State = document.getElementById("P_State");

                    StateList.forEach(function(city) {
                        var option = document.createElement("option");
                        option.value = city.ID;
                        option.text = city.Name;
                        P_State.appendChild(option);
                    });

                      var B_State = document.getElementById("B_State");

                    StateList.forEach(function(city) {
                        var option = document.createElement("option");
                        option.value = city.ID;
                        option.text = city.Name;
                        B_State.appendChild(option);
                    });
        };



          

            function CopyAddress() {
            if ($("#chkSameAddress").is(":checked")) {

                $("#P_Address").val($("#S_Address").val());
                $("#P_Landmark").val($("#S_Landmark").val());
                $("#P_Pincode").val($("#S_Pincode").val());


                var salesState = $("#S_State").val();
                $("#P_State").val(salesState);


                if (salesState !== "") {
                    var salesCity = $("#S_City").val();


                    $.ajax({
                        url: '@Url.Action("GetCitiesByState", "Users_Master")',
                        type: "GET",
                        data: { stateId: salesState },
                        success: function (cityList) {
                            var pCity = document.getElementById("P_City");
                            pCity.innerHTML = '<option value="">-- Select City --</option>';

                            cityList.forEach(function (city) {
                                var option = document.createElement("option");
                                option.value = city.id;
                                option.text = city.name;
                                pCity.appendChild(option);
                            });

                            $("#P_City").val(salesCity);
                        }
                    });
                }
            } else {

                $("#P_Address, #P_Landmark, #P_Pincode").val("");
                $("#P_State, #P_City").val("");
            }
        }

</script>


