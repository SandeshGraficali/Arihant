@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="~/css/datatables.css" rel="stylesheet" />
    <link href="~/css/allmin.css" rel="stylesheet" />
    <style>
        /* --- General Layout --- */
        .floatleft {
            float: left;
        }

        .padding10 {
            padding: 10px;
        }

        .padding20 {
            padding: 20px;
        }

        .marginB20 {
            margin-bottom: 20px;
        }

        .BorderRounded5 {
            border-radius: 5px;
        }

        .BorderRounded10 {
            border-radius: 10px;
        }

        .Shadow {
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }

        .clear {
            clear: both;
        }

        .bg {
            background-color: #f4f7f6;
        }

        .BgColor1 {
            background-color: #ffffff;
        }

        .Border1 {
            border: 1px solid #dee2e6;
        }

        /* --- Responsive Header --- */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        /* --- Buttons --- */
        .btn-action {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        .btn-add {
            background-color: #000080;
            color: white;
        }

        .btn-edit {
            background-color: #ffc107;
            color: black;
            margin-right: 5px;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            width: 200px;
            font-size: 16px;
        }

        .text-right {
            text-align: right;
        }

        .grid-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 15px;
        }

        .custom-grid {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            font-size: 13px;
            border: 1px solid #eee;
        }

            .custom-grid th, .custom-grid td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
                border-bottom: 1px solid #eee;
            }

            .custom-grid th {
                background-color: #f1f3f9;
                font-weight: bold;
            }

        /* --- Modal --- */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
            padding: 20px 10px;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 70%;
            position: relative;
        }

        .TextBox {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        @@media (max-width: 768px) {
            .col-lg-4, .col-lg-6, .col-lg-12 {
                width: 100% !important;
                float: none !important;
                padding: 5px 5px !important;
            }

            .modal-content {
                width: 95% !important;
            }

            .btn-save {
                width: 100% !important;
            }
        }
    </style>
</head>

<body class="bg">
    <br />
    <br />
    <div class="wrapper paddingLR10">
        <form id="VendorForm">
            <input type="hidden" id="VendorID" name="VendorID" value="@(Model?.VendorID ?? 0)" />
            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="NormalTextBig"><strong>Vendor Details</strong></div><hr />
                <div class="col-lg-4 floatleft padding10"><label>Vendor Name<span style="color:red;margin-left:3px">*</span></label><input type="text" id="VendorName" name="VendorName" class="TextBox" required></div>
                <div class="col-lg-4 floatleft padding10"><label>GST No.<span style="color:red;margin-left:3px">*</span></label><input type="text" id="GSTNo" name="GSTNo" class="TextBox" required></div>
                <div class="col-lg-4 floatleft padding10"><label>Email ID</label><input type="email" id="EmailID" name="EmailID" class="TextBox"></div>
                <div class="col-lg-4 floatleft padding10"><label>PAN NO.</label><input type="text" id="PANNO" name="PANNO" class="TextBox"></div>
                <div class="col-lg-4 floatleft padding10"><label>TIN NO.</label><input type="text" id="TINNO" name="TINNO" class="TextBox"></div>
                <div class="col-lg-4 floatleft padding10"><label>Compare Payment Terms</label><input type="text" name="Compare_Payment_Terms" class="TextBox"></div>
                <div class="col-lg-4 floatleft padding10">
                    <label>Payment Terms (Days)</label>



                    <select id="Payment_Terms" class="TextBox">
                        <option value="">-- Select Type --</option>
                        @if (ViewBag.PurchaseList != null)
                        {
                            foreach (var item in (IEnumerable<Arihant.Models.Company_Master.C_Master>)ViewBag.PurchaseList)
                            {
                                <option value="@item.ID">@item.Name</option>
                            }
                        }
                    </select>
                </div>


                <div class="col-lg-4 floatleft padding10"><label>Remark</label><input type="text" name="Vremark" class="TextBox"></div>
                <div class="clear"></div>
            </div>
            @Html.Partial("_ContactCommunication")
            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Address Details</strong></div>
                    <button type="button" id="Add" class="btn-action btn-add" onclick="ShowAdd()">+ Add Address </button>


                </div>
                <hr />
                <div id="MAinAddDive" style="display:none">
                    <div class="col-lg-4 floatleft padding10">
                        <label>Address Type<span style="color:red;margin-left:3px">*</span></label>
                        <select id="ddlAddressType" class="TextBox">
                            <option value="">-- Select Type --</option>
                            @if (ViewBag.Addresslist != null)
                            {
                                foreach (var item in (IEnumerable<Arihant.Models.Company_Master.C_Master>)ViewBag.Addresslist)
                                {
                                    <option value="@item.ID">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="clear"></div>

                    @Html.Partial("_AddressDetails", "MainAddr")
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-4 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                    </div>
                    <div class="col-lg-2 floatleft padding10">
                        <button type="button" id="AddMainADd" style="display:none" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>
                    </div>

                </div>


                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblAddress">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Address 1</th>
                                <th>Address 2</th>
                                <th>Landmark</th>
                                <th>Pincode</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>GST No.</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft BgColor1 Border1 padding20 BorderRounded10 Shadow marginB20">
                <div class="section-header">
                    <div class="NormalTextBig"><strong>Bank Details</strong></div>
                    <button type="button" id="AddBank" class="btn-action btn-add" onclick="DisplayBankDiv()">+ Add Bank </button>

                </div>
                <hr />
                <div id="BankDiv" style="display:none">
                    @Html.Partial("_BankDetails", "MainBank")
                    <div class="clear"></div>

                </div>


                <div class="col-lg-2 floatleft padding10">
                    <button type="button" id="AddBankList" style="display:none" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank Account</button>
                </div>

                <div class="grid-container">
                    <table style="display:none" class="custom-grid" id="tblBank">
                        <thead>
                            <tr>
                                <th>Bank Name</th>
                                <th>Branch Name</th>
                                <th>Account No</th>
                                <th>IFSC</th>
                                <th>Account Type</th>
                                <th>Holder</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-12 floatleft padding20 text-right">
                <div class="col-lg-12 floatleft padding20 text-right">
                    <button class="btn-action"
                            style="background-color:#000080; color:white; width:100px; font-size:16px;"
                            onclick="location.href='@Url.Action("Vender_Master", "Users_Master")'">
                        Back
                    </button>

                    @if (ViewBag.IsEdit == true)
                    {
                        <button type="submit" class="btn-action" style="background-color:#ffc107; color:black; width:200px; font-size:16px;">Update Vendor Master</button>
                    }
                    else
                    {
                        <button type="submit" class="btn-action btn-save">Save</button>
                    }
                </div>
            </div>
        </form>
    </div>

    <div id="editModal" class="custom-modal">
        <div class="modal-content Shadow">
            <div class="section-header">
                <div class="NormalTextBig FontColor1"><strong id="modalHeading">Edit Details</strong></div>
                <button type="button" onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <hr />
            <div id="modalInputs" class="clear"></div>
            <div class="clear"></div>
            <hr />
            <div class="text-right">
                <button type="button" class="btn-action" style="background:#6c757d; color:white;" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-action btn-add" id="btnSaveUpdate">Update Details</button>
            </div>
        </div>
    </div>
    <script>
    
        window.AppConfig = {
            UserMasterBaseUrl: '@Url.Content(Configuration["ApiSettings:UserMasterBaseUrl"])'
        };
        console.log("AppConfig Initialized:", window.AppConfig);
    </script>
    <script src="~/js/jquery-3.7.1.js"></script>
    <script src="~/js/sweetalert2.js"></script>
    <script src="~/js/masters/address.js"></script>
    <script src="~/js/masters/contactdetails.js"></script>
    <script src="~/js/masters/bankdetails.js"></script>
    <script>
        var countryList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.countrylist));


        function DisplayBankDiv() {
          $("#modalHeading")
            .text("Add Bank Details");
          var bankContent = $('#BankDiv')
            .html();
          $("#modalInputs")
            .html(bankContent);
          $("#editModal")
            .show();
          $("#btnSaveUpdate")
            .hide();
          $("#btnModalAddBank")
            .remove();
          var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
            '<button type="button" id="btnModalAddBank" class="btn-action btn-add" onclick="AddBankToGrid()">+ Add Bank to List</button>' +
            '</div>';
          $("#modalInputs")
            .append(addBtn);
        }


        function ShowAdd() {
          $("#modalHeading")
            .text("Add Address Details");
          var addressContent = $('#MAinAddDive')
            .html();
          $("#modalInputs")
            .html(addressContent);
          $("#editModal")
            .show();
          $("#btnSaveUpdate")
            .hide();
          $("#btnModalAddAddr")
            .remove();

          var addBtn = '<div class="col-lg-12 floatleft padding10 text-right">' +
            '<button type="button" id="btnModalAddAddr" class="btn-action btn-add" onclick="AddAddressToGrid()">+ Add Address to List</button>' +
            '</div>';
          $("#modalInputs")
            .append(addBtn);
          $('#MAinAddDive')
            .hide();
        }


        $(document)
          .ready(function() {
            InitializeStates();

            var isEdit = '@ViewBag.IsEdit'.toLowerCase() === 'true';
            if (isEdit) {
              PopulateGridsForEdit();
            }

            $("#VendorForm")
              .on("submit", function(e) {
                e.preventDefault();
                SaveAllData();
              });
          });

        function InitializeStates() {
          bindDropdownList(["MainAddr_Country", "BankAddr_Country"], countryList);
        }


        function PopulateGridsForEdit() {

          $('#tblBank')
            .show();
          $('#tblAddress')
            .show();
          var fullModel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
          console.log("Binding Full Vendor Model Data...", fullModel);
          if (!fullModel) return;
          $("#VendorName")
            .val(fullModel.VendorName);
          $("#GSTNo")
            .val(fullModel.GSTNo);
          $("#EmailID")
            .val(fullModel.EmailID);
          $("#Payment_Terms").val(fullModel.Payment_Terms);
          $("#PANNO")
            .val(fullModel.PANNO);
             $("#TINNO")
            .val(fullModel.TINNO);
          $("input[name='Compare_Payment_Terms']")
            .val(fullModel.Compare_Payment_Terms);
          $("input[name='Payment_Terms']")
            .val(fullModel.Payment_Terms);
          $("input[name='Vremark']")
            .val(fullModel.Remark);
                bindContactDetails(
            fullModel.Email,            
            fullModel.AlternateEmail,   
            fullModel.ContactPersonName,
            fullModel.OffMobileNO,      
            fullModel.WhatsappNo,      
            fullModel.Website,          
            fullModel.Tel1,             
            fullModel.MobileNo          
        );
          bindAddressTable(fullModel.AddressList);
          bindBankTable(fullModel.BankList);
        }

          
             
        function closeModal()
        {
          $("#editModal")
            .hide();
          currentRow = null;
        }



        function SaveAllData()
        {

          const vendorName = $("#VendorName")
            .val()
            .trim();
          const gstNo = $("#GSTNo")
            .val()
            .trim();
          const offMobile = $("input[name='MobileNo']")
            .val()
            .trim();
          const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;

             if (!gstRegex.test(gstNo)) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid GST Format',
                text: 'Expected format: 22AAAAA0000A1Z5',
            });
            return;
        }

          if (!vendorName || !gstNo || !offMobile) {
               Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please fill all mandatory fields (Vendor Name, GST, and Mobile).'
               
            });
            return;
          }

             if ($("#tblAddress tbody tr").length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Address Required',
                text: 'Please add at least one Address to the list.'
            });
            return;
        }

        if ($("#tblBank tbody tr").length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Bank Details Required',
                text: 'Please add at least one Bank account.'
            });
            return;
        }

          const formData = {
            VendorID: $("#VendorID")
              .val()
            , VendorName: vendorName
            , GSTNO: gstNo
            , PANNO: $("#PANNO")
              .val()
              .trim()
               , TINNO: $("#TINNO")
              .val()
              .trim()
            , EmailID: $("#EmailID")
              .val()
            , Compare_Payment_Terms: $("input[name='Compare_Payment_Terms']")
              .val()
            , Payment_Terms: $("#Payment_Terms")
              .val()
            , Remark: $("input[name='Vremark']")
              .val()
            , ...getContactDetails()
            , AddressList: getAddressTableData()
            , BankList: getBankTableData()
          };




          $.ajax({
            url: '@Url.Action("SaveVendor", "Users_Master")'
            , type: 'POST'
            , data: {
              jsonData: JSON.stringify(formData)
            }
            , success: function(response) {
              if (response.success) {
                Swal.fire('Success', 'Vendor Master saved successfully!', 'success')
                  .then(() => {
                    window.location.href = '@Url.Action("Vender_Master", "Users_Master")';
                  });
              } else {
                Swal.fire('Error', response.message || 'Saving failed.', 'error');
              }
            }
            , error: function() {
              Swal.fire('Error', 'Could not reach the server.', 'error');
            }
          });
        }
    </script>
</body>