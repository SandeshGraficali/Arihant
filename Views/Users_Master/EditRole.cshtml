@model IEnumerable<IGrouping<string, Arihant.Models.Rights_Master.EditRoleViewModel>>

<div class="card" style="width: 60%; margin: 50px auto; border: 1px solid #ccc; padding: 25px; font-family: sans-serif; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px;">

    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #333;">Edit Role Rights</h3>
        <a href="@Url.Action("Manage_Role_Master", "Users_Master")" style="text-decoration: none; color: #666; font-size: 14px;">&larr; Back to List</a>
    </div>

    <input type="hidden" id="hdnRoleID" value="@ViewBag.RoleID" />
    <div class="form-section" style="margin-bottom: 25px; display: flex; align-items: center;">
        <label style="margin-right: 15px; white-space: nowrap;"><b>Role Name:</b></label>
        <input type="text" id="txtRoleName" class="form-control" style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;"
               value="@ViewBag.RoleName" placeholder="Enter Role Name" />
    </div>

    <label style="margin-bottom: 12px; display: block; color: #444;"><b>Select Menu Rights:</b></label>

    <div class="rights-container" style="border: 1px solid #eee; padding: 15px; max-height: 500px; overflow-y: auto; background: #fafafa; border-radius: 6px;">

        <partial name="~/Views/Shared/Menu/_MenuRightsPartial.cshtml" model="ViewBag.GroupedMenuRights" />
    </div>

    <div style="text-align: right; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
        <button class="btn btn-primary" style="padding: 10px 40px; font-weight: bold; background: #007bff; border: none; color: #fff; border-radius: 4px; cursor: pointer;" onclick="UpdateRole()">
            Update Role
        </button>
    </div>
</div>
<script src="~/js/jquery-3.7.1.js"></script>
<script src="~/js/sweetalert2.js"></script>
<script>
    $(document).ready(function () {
       var groupedModel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

    console.log(groupedModel);
    var assignedMenuIds = [];

    if (groupedModel) {
        groupedModel.forEach(group => {
          
            group.forEach(item => {
                if (item.IsAssigned) {
                    assignedMenuIds.push(item.MenuID);
                }
            });
        });
    }

  
    $("input[name='selectedMenus']").prop('checked', false);


    assignedMenuIds.forEach(menuID => {
        $(`input[name='selectedMenus'][value='${menuID}']`).prop('checked', true);
    });


    $('.module-card').each(function() {
        var $card = $(this);
        var total = $card.find('.child-check').length;
        var checked = $card.find('.child-check:checked').length;
        if (total > 0) {
            $card.find('.parent-check').prop('checked', total === checked);
        }
    });

        $('.parent-check').on('change', function() {
            $(this).closest('.module-group').find('.child-check').prop('checked', $(this).is(':checked'));
        });

        $('.child-check').on('change', function() {
            var group = $(this).closest('.module-group');
            var total = group.find('.child-check').length;
            var checked = group.find('.child-check:checked').length;
            group.find('.parent-check').prop('checked', total === checked);
        });
    });

        function UpdateRole() {
        var menuIds = [];
        $('.child-check:checked').each(function () {
            menuIds.push(parseInt($(this).val()));
        });

        var postData = {
            RoleID: parseInt($('#hdnRoleID').val()),
            RoleName: $('#txtRoleName').val(),
            MenuIDs: menuIds
        };

        if (!postData.RoleName) {
            alert("Please enter a Role Name");
            return;
        }

        Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to update the role permissions?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, update it!',
            cancelButtonText: 'No',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                
                var updateUrl = '@Url.Action("UpdateRolePermissions", "Users_Master")';

                $.ajax({
                    url: updateUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(postData),
                    success: function (response) {

                        if (response.result === "1") {
                            Swal.fire({
                                icon: 'success',
                                title: 'Updated!',
                                text: 'Role permissions have been updated successfully.',
                                timer: 2000,
                                showConfirmButton: false,
                                position: 'center'
                            }).then(() => {
                                window.location.href = '@Url.Action("Manage_Role_Master", "Users_Master")';
                            });
                        }
                        else if (response.result === "0") {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Already Exists',
                                text: 'A role with this name already exists in the system.',
                                confirmButtonColor: '#3085d6',
                                position: 'center'
                            });
                        }
                        else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Execution Failed',
                                text: response.message,
                                confirmButtonColor: '#d33',
                                position: 'center'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'System Error',
                            text: 'Could not connect to the server.',
                            position: 'center'
                        });
                    }
                });
            }
        });
    }

</script>